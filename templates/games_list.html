<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Games</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
    .nav a { margin-right: 1rem; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
    th { background: #f5f5f5; position: sticky; top: 0; }
    .small { color: #666; font-size: 0.9rem; }
    .loading-backdrop { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.6); display: none; align-items: center; justify-content: center; z-index: 999; }
    .loading-backdrop.is-active { display: flex; }
    .loading-spinner { width: 48px; height: 48px; border: 4px solid rgba(0, 0, 0, 0.1); border-top-color: #1976d2; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
  <script>
    function filterTable() {
      const q = (document.getElementById('q').value || '').toLowerCase();
      const rows = document.querySelectorAll('tbody tr');
      rows.forEach(tr => {
        const text = tr.textContent.toLowerCase();
        tr.style.display = text.includes(q) ? '' : 'none';
      });
    }
  </script>
</head>
<body>
  <div class="nav">
    <a href="/">Home</a>
    <a href="{% url 'export_csv' %}">Export CSV</a>
  </div>
  <div id="loadingIndicator" class="loading-backdrop" aria-hidden="true">
    <div class="loading-spinner" role="status" aria-label="Loading"></div>
  </div>
  <h1>Games</h1>
  <div class="small">
    Showing <span id="rangeStart">{{ start_idx }}</span>â€“<span id="rangeEnd">{{ end_idx }}</span>
    of <span id="rowsCount">{{ rows_count|default:rows|length }}</span> rows
  </div>
  <div style="margin: 8px 0 12px 0;">
    <form id="filtersForm" method="get" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px 16px; align-items:end;">
      <div id="categoriesFilter" style="grid-column: 1 / -1;">
        <label>Categories</label>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px; flex-wrap:wrap;">
          <input id="categoriesSearch" type="text" placeholder="Search categories..." style="padding:6px 8px; min-width:240px;">
          <button type="button" id="clearCategories">Clear</button>
        </div>
        <div id="categoriesList" style="max-height: 240px; overflow:auto; border:1px solid #ddd; padding:6px; border-radius:6px; background:#fff;">
          <div id="categoriesTop">
            {% for pair in top_categories_pairs %}
            {% with cat=pair.0 cnt=pair.1 %}
            <label class="cat-item" data-name="{{ cat|lower }}" style="display:inline-flex; align-items:center; gap:6px; margin:4px 10px 4px 0;">
              <input type="checkbox" name="categories" value="{{ cat }}" {% if cat in selected_categories %}checked{% endif %}>
              <span>{{ cat }} ({{ cnt }})</span>
            </label>
            {% endwith %}
            {% endfor %}
          </div>
          {% if other_categories %}
          <details id="categoriesMore" {% if open_more_categories %}open{% endif %}>
            <summary>Show {{ other_categories|length }} more</summary>
            <div id="categoriesListRest" style="margin-top:6px;">
              {% for pair in other_categories_pairs %}
              {% with cat=pair.0 cnt=pair.1 %}
              <label class="cat-item" data-name="{{ cat|lower }}" style="display:inline-flex; align-items:center; gap:6px; margin:4px 10px 4px 0;">
                <input type="checkbox" name="categories" value="{{ cat }}" {% if cat in selected_categories %}checked{% endif %}>
                <span>{{ cat }} ({{ cnt }})</span>
              </label>
              {% endwith %}
              {% endfor %}
            </div>
          </details>
          {% endif %}
        </div>
      </div>
      <div>
        <label>Search title</label>
        <input name="q" value="{{ q }}" type="text" placeholder="e.g. Catan" style="padding:6px 8px; width: 100%;">
      </div>
      <div>
        <label>Owned</label>
        <select name="owned_state" style="padding:6px 8px; width: 100%;">
          <option value="all" {% if owned_state == 'all' %}selected{% endif %}>All</option>
          <option value="owned" {% if owned_state == 'owned' %}selected{% endif %}>Owned</option>
          <option value="not" {% if owned_state == 'not' %}selected{% endif %}>Not Owned</option>
        </select>
      </div>
      <div>
        <label>Type</label>
        <select name="type" style="padding:6px 8px; width: 100%;">
          <option value="all" {% if type_filter == 'all' %}selected{% endif %}>All</option>
          <option value="base" {% if type_filter == 'base' %}selected{% endif %}>Base Game</option>
          <option value="expansion" {% if type_filter == 'expansion' %}selected{% endif %}>Expansion</option>
        </select>
      </div>
      <div>
        <label>Playable</label>
        <select name="playable" style="padding:6px 8px; width: 100%;">
          <option value="all" {% if playable == 'all' %}selected{% endif %}>All</option>
          <option value="playable" {% if playable == 'playable' %}selected{% endif %}>Playable</option>
          <option value="not" {% if playable == 'not' %}selected{% endif %}>Not Playable</option>
        </select>
      </div>
      <div>
        <label>Player Count</label>
        <select name="player_count" style="padding:6px 8px; width: 100%;">
          <option value="all" {% if player_count == 'all' %}selected{% endif %}>All</option>
          <option value="1" {% if player_count == '1' %}selected{% endif %}>1</option>
          <option value="2" {% if player_count == '2' %}selected{% endif %}>2</option>
          <option value="3" {% if player_count == '3' %}selected{% endif %}>3</option>
          <option value="4" {% if player_count == '4' %}selected{% endif %}>4</option>
          <option value="5" {% if player_count == '5' %}selected{% endif %}>5</option>
          <option value="6" {% if player_count == '6' %}selected{% endif %}>6</option>
          <option value="7" {% if player_count == '7' %}selected{% endif %}>7</option>
          <option value="8plus" {% if player_count == '8plus' %}selected{% endif %}>8+</option>
        </select>
      </div>
      <div>
        <label style="display:block; margin-bottom:4px;">Year range</label>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
          <input id="min_year" name="min_year" type="range" min="{{ year_slider_min }}" max="{{ year_slider_max }}" step="1" value="{{ min_year|default:year_slider_min }}" style="width:100%;">
          <span id="min_year_val" style="min-width:48px; text-align:right;"></span>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="max_year" name="max_year" type="range" min="{{ year_slider_min }}" max="{{ year_slider_max }}" step="1" value="{{ max_year|default:year_slider_max }}" style="width:100%;">
          <span id="max_year_val" style="min-width:48px; text-align:right;"></span>
        </div>
      </div>
      <div>
        <label style="display:block; margin-bottom:4px;">Avg Rating range</label>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
          <input id="min_avg_rating" name="min_avg_rating" type="range" min="0" max="10" step="0.1" value="{{ min_avg_rating|default:'0' }}" style="width:100%;">
          <span id="min_avg_rating_val" style="min-width:36px; text-align:right;"></span>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="max_avg_rating" name="max_avg_rating" type="range" min="0" max="10" step="0.1" value="{{ max_avg_rating|default:'10' }}" style="width:100%;">
          <span id="max_avg_rating_val" style="min-width:36px; text-align:right;"></span>
        </div>
      </div>
      <div>
        <label style="display:block; margin-bottom:4px;">Weight range</label>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
          <input id="min_weight" name="min_weight" type="range" min="0" max="5" step="0.1" value="{{ min_weight|default:'0' }}" style="width:100%;">
          <span id="min_weight_val" style="min-width:36px; text-align:right;"></span>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="max_weight" name="max_weight" type="range" min="0" max="5" step="0.1" value="{{ max_weight|default:'5' }}" style="width:100%;">
          <span id="max_weight_val" style="min-width:36px; text-align:right;"></span>
        </div>
      </div>
      <div>
        <label>Min voters</label>
        <input name="min_voters" type="number" min="0" value="{{ min_voters }}" style="padding:6px 8px; width:100%;">
      </div>
      <div>
        <label>Rows per page</label>
        <select name="page_size" id="page_size" style="padding:6px 8px; width:100%;">
          <option value="50" {% if page_size|stringformat:'s' == '50' %}selected{% endif %}>50</option>
          <option value="100" {% if page_size|stringformat:'s' == '100' %}selected{% endif %}>100</option>
          <option value="200" {% if page_size|stringformat:'s' == '200' %}selected{% endif %}>200</option>
          <option value="500" {% if page_size|stringformat:'s' == '500' %}selected{% endif %}>500</option>
          <option value="1000" {% if page_size|stringformat:'s' == '1000' %}selected{% endif %}>1000</option>
        </select>
      </div>
      <input type="hidden" name="page" id="page_input" value="{{ page }}">
      <input type="hidden" name="sort" value="{{ sort }}">
      <input type="hidden" name="dir" value="{{ dir }}">
      <div style="display:flex; gap:10px;">
        <button type="submit">Apply</button>
        <a href="{% url 'games_list' %}">Clear</a>
        <button type="button" id="resetDefaults">Reset to defaults</button>
      </div>
    </form>
  </div>
  <table>
    <thead>
      <tr>
        {% with qs=qs_nosort %}
        <th><a href="?sort=score_factor&dir={% if sort == 'score_factor' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Score Factor{% if sort == 'score_factor' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=title&dir={% if sort == 'title' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Game Title{% if sort == 'title' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=game_id&dir={% if sort == 'game_id' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Game ID{% if sort == 'game_id' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=year&dir={% if sort == 'year' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Year{% if sort == 'year' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=bgg_rank&dir={% if sort == 'bgg_rank' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">BGG Rank{% if sort == 'bgg_rank' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=avg_rating&dir={% if sort == 'avg_rating' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Average Rating{% if sort == 'avg_rating' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=num_voters&dir={% if sort == 'num_voters' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Number of Voters{% if sort == 'num_voters' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=weight&dir={% if sort == 'weight' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Weight{% if sort == 'weight' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=weight_votes&dir={% if sort == 'weight_votes' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Weight Votes{% if sort == 'weight_votes' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=owned&dir={% if sort == 'owned' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Owned{% if sort == 'owned' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=type&dir={% if sort == 'type' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Type{% if sort == 'type' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=categories_str&dir={% if sort == 'categories_str' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Categories{% if sort == 'categories_str' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=player_count&dir={% if sort == 'player_count' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Player Count{% if sort == 'player_count' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=best_pct&dir={% if sort == 'best_pct' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Best %{% if sort == 'best_pct' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=best_votes&dir={% if sort == 'best_votes' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Best Votes{% if sort == 'best_votes' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=rec_pct&dir={% if sort == 'rec_pct' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Rec. %{% if sort == 'rec_pct' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=rec_votes&dir={% if sort == 'rec_votes' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Rec. Votes{% if sort == 'rec_votes' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=not_pct&dir={% if sort == 'not_pct' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Not %{% if sort == 'not_pct' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=not_votes&dir={% if sort == 'not_votes' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Not Votes{% if sort == 'not_votes' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=total_votes&dir={% if sort == 'total_votes' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Total Votes{% if sort == 'total_votes' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=pc_score&dir={% if sort == 'pc_score' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Player Count Score{% if sort == 'pc_score' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        <th><a href="?sort=playable&dir={% if sort == 'playable' and dir == 'asc' %}desc{% else %}asc{% endif %}{{ qs }}">Playable{% if sort == 'playable' %}{% if dir == 'asc' %} &uarr;{% else %} &darr;{% endif %}{% endif %}</a></th>
        {% endwith %}
      </tr>
    </thead>
    <tbody id="rows">
      {% include 'partials/games_rows.html' %}
    </tbody>
  </table>
  <div id="pager" style="margin-top:10px; display:flex; gap:8px; align-items:center;">
    <button type="button" id="prevPage">Prev</button>
    <span>Page <span id="pageDisplay">{{ page }}</span> of <span id="pagesTotal">{{ num_pages }}</span></span>
    <button type="button" id="nextPage">Next</button>
  </div>
  <script>
    function clampRanges(minEl, maxEl) {
      const minv = parseFloat(minEl.value);
      const maxv = parseFloat(maxEl.value);
      if (minv > maxv) {
        maxEl.value = minv;
      }
    }
    function updateLabels() {
      const minAR = document.getElementById('min_avg_rating');
      const maxAR = document.getElementById('max_avg_rating');
      const minAW = document.getElementById('min_weight');
      const maxAW = document.getElementById('max_weight');
      const minY = document.getElementById('min_year');
      const maxY = document.getElementById('max_year');
      if (minAR && maxAR) {
        clampRanges(minAR, maxAR);
        document.getElementById('min_avg_rating_val').textContent = parseFloat(minAR.value).toFixed(1);
        document.getElementById('max_avg_rating_val').textContent = parseFloat(maxAR.value).toFixed(1);
      }
      if (minAW && maxAW) {
        clampRanges(minAW, maxAW);
        document.getElementById('min_weight_val').textContent = parseFloat(minAW.value).toFixed(1);
        document.getElementById('max_weight_val').textContent = parseFloat(maxAW.value).toFixed(1);
      }
      if (minY && maxY) {
        clampRanges(minY, maxY);
        document.getElementById('min_year_val').textContent = parseInt(minY.value);
        document.getElementById('max_year_val').textContent = parseInt(maxY.value);
      }
    }
    ['min_avg_rating','max_avg_rating','min_weight','max_weight','min_year','max_year'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', updateLabels);
    });
    updateLabels();

    const loadingIndicator = document.getElementById('loadingIndicator');

    // Build query string from the form
    function buildQuery() {
      const form = document.getElementById('filtersForm');
      const fd = new FormData(form);
      // Convert checkbox on/off to presence of value
      const params = new URLSearchParams();
      for (const [k, v] of fd.entries()) {
        // Skip empty values
        if (v === null || v === '') continue;
        if (k === 'categories') {
          params.append(k, v);
        } else {
          params.set(k, v);
        }
      }
      return params.toString();
    }

    async function updateRows() {
      const qs = buildQuery();
      const url = new URL(window.location.origin + '{% url 'games_rows' %}');
      url.search = qs;
      if (loadingIndicator) loadingIndicator.classList.add('is-active');
      try {
        const resp = await fetch(url, { headers: { 'x-requested-with': 'XMLHttpRequest' } });
        if (!resp.ok) return;
        const data = await resp.json();
        const tbody = document.getElementById('rows');
        if (tbody) tbody.innerHTML = data.html;
        const countEl = document.getElementById('rowsCount');
        if (countEl) countEl.textContent = data.count;
        // Update pagination indicators
        const rs = document.getElementById('rangeStart'); if (rs) rs.textContent = data.start;
        const re = document.getElementById('rangeEnd'); if (re) re.textContent = data.end;
        const pd = document.getElementById('pageDisplay'); if (pd) pd.textContent = data.page;
        const pt = document.getElementById('pagesTotal'); if (pt) pt.textContent = data.num_pages;
        // Update the visible URL (preserve sort/filters)
        const pageUrl = new URL(window.location.href);
        pageUrl.search = qs;
        window.history.replaceState({}, '', pageUrl);
      } catch (e) {
        // Silent failure; keep current content
      } finally {
        if (loadingIndicator) loadingIndicator.classList.remove('is-active');
      }
    }

    // Auto-submit behavior with debounce
    const form = document.getElementById('filtersForm');
    let timer = null;
    function submitDebounced(delay = 400) {
      if (!form) return;
      if (timer) clearTimeout(timer);
      timer = setTimeout(() => {
        updateRows();
      }, delay);
    }

    // Auto-submit on dropdowns and checkboxes instantly
    if (form) {
      form.querySelectorAll('select, input[type="checkbox"]').forEach(el => {
        el.addEventListener('change', () => submitDebounced(10));
      });
      // Debounce on text, number, and range inputs
      form.querySelectorAll('input[type="text"]:not(#categoriesSearch), input[type="number"], input[type="range"]').forEach(el => {
        el.addEventListener('input', () => submitDebounced(400));
      });
      // When filters (not pagination controls) change, reset to page 1
      form.querySelectorAll('input[name="q"], select[name="owned_state"], select[name="type"], select[name="playable"], select[name="player_count"], input[type="checkbox"][name="categories"], input[name="min_year"], input[name="max_year"], input[name="min_avg_rating"], input[name="max_avg_rating"], input[name="min_weight"], input[name="max_weight"], input[name="min_voters"]').forEach(el => {
        el.addEventListener('change', () => { const p = document.getElementById('page_input'); if (p) p.value = '1'; });
        el.addEventListener('input', () => { const p = document.getElementById('page_input'); if (p) p.value = '1'; });
      });
    }

    const resetBtn = document.getElementById('resetDefaults');
    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        const form = resetBtn.closest('form');
        if (!form) return;
        // Set defaults
        form.querySelector('[name="q"]').value = '';
        form.querySelector('[name="owned_state"]').value = 'all';
        form.querySelector('[name="type"]').value = 'all';
        form.querySelector('[name="playable"]').value = 'playable';
        form.querySelector('[name="player_count"]').value = 'all';
        const minYear = form.querySelector('#min_year'); if (minYear) minYear.value = '{{ year_slider_min }}';
        const maxYear = form.querySelector('#max_year'); if (maxYear) maxYear.value = '{{ year_slider_max }}';
        const minAR = form.querySelector('#min_avg_rating'); if (minAR) minAR.value = '0';
        const maxAR = form.querySelector('#max_avg_rating'); if (maxAR) maxAR.value = '10';
        
        const minW = form.querySelector('#min_weight'); if (minW) minW.value = '0';
        const maxW = form.querySelector('#max_weight'); if (maxW) maxW.value = '5';
        
        const minV = form.querySelector('[name="min_voters"]'); if (minV) minV.value = '';
        form.querySelector('[name="sort"]').value = 'score_factor';
        form.querySelector('[name="dir"]').value = 'desc';
        const p = form.querySelector('[name="page"]'); if (p) p.value = '1';
        const ps = form.querySelector('[name="page_size"]'); if (ps) ps.value = '200';
        // Clear categories checkboxes
        document.querySelectorAll('input[type="checkbox"][name="categories"]').forEach(cb => cb.checked = false);
        updateLabels();
        updateRows();
      });

    // Categories search and clear
    const catSearch = document.getElementById('categoriesSearch');
    if (catSearch) {
      let catSearchTimer = null;
      catSearch.addEventListener('input', () => {
        if (catSearchTimer) clearTimeout(catSearchTimer);
        catSearchTimer = setTimeout(() => {
          const q = (catSearch.value || '').toLowerCase();
          const items = document.querySelectorAll('#categoriesList .cat-item');
          for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const name = el.getAttribute('data-name') || '';
            el.style.display = name.includes(q) ? 'inline-flex' : 'none';
          }
          const more = document.getElementById('categoriesMore');
          if (more) {
            if (q) more.setAttribute('open', 'open');
            else more.removeAttribute('open');
          }
        }, 200);
      });
    }
    const clearCats = document.getElementById('clearCategories');
    if (clearCats) {
      clearCats.addEventListener('click', () => {
        document.querySelectorAll('input[type="checkbox"][name="categories"]').forEach(cb => cb.checked = false);
        const p = document.getElementById('page_input'); if (p) p.value = '1';
        submitDebounced(10);
      });
    }
    }

    // Pager controls
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    function changePage(delta) {
      const p = document.getElementById('page_input');
      const total = parseInt(document.getElementById('pagesTotal')?.textContent || '1');
      let cur = parseInt(p?.value || '1');
      cur = isNaN(cur) ? 1 : cur;
      let next = cur + delta;
      if (next < 1) next = 1;
      if (next > total) next = total;
      if (p) p.value = String(next);
      submitDebounced(10);
    }
    if (prevBtn) prevBtn.addEventListener('click', () => changePage(-1));
    if (nextBtn) nextBtn.addEventListener('click', () => changePage(1));
  </script>
</body>
</html>
