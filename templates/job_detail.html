
{% extends 'base.html' %}

{% block title %}Job #{{ job.id }} Ãƒâ€šÃ‚Â&middot; Data Pipeline{% endblock %}

{% block extra_head %}
<style>
  .job-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .status-chip {
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    background: var(--surface-muted);
    border: 1px solid var(--border);
    font-weight: 600;
  }
  .progress-wrapper {
    margin: 1rem 0;
    background: var(--surface-muted);
    border-radius: 10px;
    overflow: hidden;
    height: 12px;
  }
  .progress-bar {
    background: var(--primary);
    height: 100%;
    width: 0;
    transition: width 0.3s ease;
  }
  .job-metadata {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .job-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.4rem;
    box-shadow: var(--shadow);
  }
  pre.job-error {
    background: #fdecef;
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid #f2c4cc;
    color: #ba1a1a;
    overflow-x: auto;
  }
</style>
{% endblock %}

{% block content %}
<section class="job-header">
  <div>
    <h1>Job #{{ job.id }}</h1>
    <p class="note">Kind: <strong>{{ job.kind|title }}</strong></p>
  </div>
  <span class="status-chip" id="statusChip">{{ job.status|title }}</span>
</section>

<div class="job-panel">
  <div class="job-metadata">
    <div>
      <strong>Progress</strong>
      <div id="progress">{{ job.progress }} / {{ job.total }}</div>
      <div class="progress-wrapper" aria-hidden="true">
        <div id="bar" class="progress-bar" style="width: {% if job.total %}{{ job.progress|floatformat:2|add:'0'|floatformat:0|floatformat }}{% else %}0{% endif %}%;"></div>
      </div>
    </div>
    <div>
      <strong>Created</strong>
      <div class="localtime" data-ts="{{ job.created_at|date:'c' }}">{{ job.created_at }}</div>
    </div>
    {% if job.finished_at %}
    <div>
      <strong>Finished</strong>
      <div class="localtime" data-ts="{{ job.finished_at|date:'c' }}">{{ job.finished_at }}</div>
    </div>
    {% endif %}
  </div>
  <p class="note">This page refreshes automatically to keep you up to date on background processing.</p>
</div>

{% if job.error %}
<section class="page-section">
  <div class="job-panel">
    <h2>Last error</h2>
    <pre class="job-error">{{ job.error }}</pre>
  </div>
</section>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
  (function() {
    const statusChip = document.getElementById('statusChip');
    const progressEl = document.getElementById('progress');
    const barEl = document.getElementById('bar');

    if (barEl) {
      const initTotal = parseFloat(barEl.dataset.initialTotal || '0');
      const initProgress = parseFloat(barEl.dataset.initialProgress || '0');
      if (initTotal) {
        const pct = Math.min(100, Math.round((initProgress / initTotal) * 100));
        barEl.style.width = pct + '%';
      }
    }

    function refreshTimes() {
      document.querySelectorAll('.localtime').forEach(el => {
        const ts = el.getAttribute('data-ts');
        if (!ts) return;
        try {
          const d = new Date(ts);
          el.textContent = d.toLocaleString();
        } catch (e) {}
      });
    }

    refreshTimes();

    function poll() {
      fetch(window.location.href, { headers: { 'x-requested-with': 'XMLHttpRequest' } })
        .then(resp => resp.ok ? resp.json() : null)
        .then(data => {
          if (!data) return;
          const status = data.status || '';
          if (statusChip) statusChip.textContent = status.charAt(0).toUpperCase() + status.slice(1);
          if (progressEl) progressEl.textContent = `${data.progress} / ${data.total}`;
          if (barEl) {
            const total = parseFloat(data.total || 0);
            const prog = parseFloat(data.progress || 0);
            if (total) {
              const pct = Math.min(100, Math.round((prog / total) * 100));
              barEl.style.width = pct + '%';
            }
            barEl.dataset.initialProgress = prog;
            barEl.dataset.initialTotal = total;
          }
          if (data.status && data.status !== 'done' && data.status !== 'error') {
            setTimeout(poll, 1500);
          }
        })
        .catch(() => {
          setTimeout(poll, 4000);
        });
    }

    setTimeout(poll, 1500);
  })();
</script>
{% endblock %}
