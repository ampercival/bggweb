<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>BGG Player Count Optimizer</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; line-height: 1.6; }
    .nav a { margin-right: 1rem; }
    .hero { max-width: 720px; margin-bottom: 2rem; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin: 2rem 0; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; background: #f8fbff; }
    .card h3 { margin-top: 0; }
    .note { color: #666; font-size: 0.95rem; }
    .actions { display:flex; gap:12px; flex-wrap:wrap; margin-top: 1.5rem; }
    .actions a { padding: 10px 16px; border-radius: 6px; background: #1e88e5; color: #fff; text-decoration:none; }
    .actions a.secondary { background: #555; }
    .user-list { list-style: none; padding: 0; margin: 0.5rem 0 0 0; display: flex; flex-wrap: wrap; gap: 8px; }
    .user-pill { border: 1px solid #ccc; border-radius: 16px; padding: 4px 10px; background: #fff; color: #333; }
    .label { font-weight: 600; color: #444; }
  </style>
</head>
<body>
  <div class="nav">
    <a href="{% url 'home' %}">Home</a>
    <a href="{% url 'games_list' %}">View Games</a>
    {% if request.user.is_authenticated and request.user.is_superuser %}
    <a href="{% url 'refresh' %}">Refresh Data</a>
    {% endif %}
    <a href="{% url 'export_csv' %}">Export CSV</a>
    {% if request.user.is_authenticated and request.user.is_superuser %}
    <a href="{% url 'admin:index' %}">Admin</a>
    {% endif %}
  </div>

  <section class="hero">
    <h1>BGG Player Count Optimizer</h1>
    <p>
      Explore BoardGameGeek data tuned for finding the best player counts. The optimizer fetches BGG rank lists, merges your collection, pulls per-game details, and scores each player count so you can plan the next game night in minutes.
    </p>
    <div class="actions">
      <a href="{% url 'games_list' %}">Browse Optimized Games</a>
      {% if request.user.is_authenticated and request.user.is_superuser %}
      <a class="secondary" href="{% url 'refresh' %}">Run a Refresh</a>
      {% endif %}
    </div>
  </section>

  <section class="stats">
    <div class="card">
      <h3>Library Size</h3>
      <div class="label">Total games in database</div>
      <div style="font-size:1.6rem; font-weight:600;">{{ total_games }}</div>
      <p class="note">Games are updated during each refresh run. Start a new refresh whenever you download a fresh ranks file or add titles to your collection.</p>
    </div>
    <div class="card">
      <h3>Last Refresh</h3>
      {% if last_refresh %}
        <div><span class="label">Status:</span> {{ last_refresh.status|title }}</div>
        <div>
          <span class="label">Completed:</span>
          {% if last_refresh.finished_at %}
            <span class="localtime" data-ts="{{ last_refresh.finished_at|date:'c' }}">{{ last_refresh.finished_at }}</span>
          {% else %}
            <span class="localtime" data-ts="{{ last_refresh.created_at|date:'c' }}">{{ last_refresh.created_at }}</span>
          {% endif %}
        </div>
        <div><span class="label">Top N:</span> {{ last_refresh.params.n|default:'' }}</div>
        <div>
          <span class="label">Users Included:</span>
          {% if last_refresh.params.usernames %}
            {{ last_refresh.params.usernames|join:", " }}
          {% elif last_refresh.params.username %}
            {{ last_refresh.params.username }}
          {% else %}
            None
          {% endif %}
        </div>
        <div><span class="label">Games processed:</span> {{ last_refresh.total }}</div>
        <p class="note"><a href="{% url 'job_detail' job_id=last_refresh.id %}">View refresh job details</a></p>
      {% else %}
        <p>No refresh has been run yet. Head over to the refresh page to download the latest ranks and populate the catalog.</p>
      {% endif %}
    </div>
    <div class="card">
      <h3>Tracked BGG Users</h3>
      {% if tracked_users %}
        <div><span class="label">Total users:</span> {{ tracked_users|length }}</div>
        <ul class="user-list">
          {% for username in tracked_users %}
          <li class="user-pill">{{ username }}</li>
          {% endfor %}
        </ul>
        <p class="note">Manage tracked usernames on the <a href="{% url 'refresh' %}">refresh page</a>.</p>
      {% else %}
        <p class="note">No tracked users yet. Add some on the <a href="{% url 'refresh' %}">refresh page</a>.</p>
      {% endif %}
    </div>
  </section>

  <script>
    (function() {
      const els = document.querySelectorAll('.localtime');
      els.forEach(el => {
        const ts = el.getAttribute('data-ts');
        if (!ts) return;
        try {
          const d = new Date(ts);
          el.textContent = d.toLocaleString();
        } catch (e) {}
      });
    })();
  </script>
</body>
</html>
